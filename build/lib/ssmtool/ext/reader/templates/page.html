<html class="has-navbar-fixed-top">

<head>
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='bulma.min.css') }}" />
    <script src="{{ url_for('static', filename='lodash.min.js') }}"></script>
    <script src="{{ url_for('static', filename='jquery-3.6.0.min.js') }}"></script>
    <style>
        #progress-bar {
            --scrollAmount: 0%;
            background-color: #6b7;
            width: var(--scrollAmount);
            height: 8px;
            position: fixed;
            top: 3.25rem;
        }

        #master {
            padding: 5%;
        }
    </style>
    <script>

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;

            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Fallback: Copying text command was ' + msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }
        function copyTextToClipboard(text) {
            if (!navigator.clipboard) {
                fallbackCopyTextToClipboard(text);
                return;
            }
            navigator.clipboard.writeText(text).then(function () {
                console.log('Async: Copying to clipboard was successful!');
            }, function (err) {
                console.error('Async: Could not copy text: ', err);
            });
        }
        let scrollToFraction = (frac) => {
            let docElem = document.documentElement,
            docBody = document.body,
            scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight;
            docElem['scrollTop'] = frac * scrollBottom;
            docBody['scrollTop'] = frac * scrollBottom;
        }

    </script>
</head>

<body onload="scrollToFraction({{ text.progress/1000000 }})">
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                <h5 class="title is-5">FLT Web Reader</h5>
            </a>
            <a id="progress-indicator" class="navbar-item" href="/">
                <p>{{text.progress/10_000}}%</p>
            </a>
        </div>
    </nav>
    <div id="progress-bar"></div>
    <div id="master" class="container">
        <h1 class="title is-1">{{text.title}}</h1>
        {% for paragraph in text.content.split("######") %}
        <h4 class="title is-4 mb-1">{{paragraph.splitlines()[0]}}</h2>
            <p>{{"\n".join(paragraph.splitlines()[1:]).replace("\n"," <br>")}}</p>
            {% endfor %}
    </div>


    <script>
        var currentScroll;
        let getScrollAmount = () => {
            let docElem = document.documentElement,
                docBody = document.body,
                scrollTop = docElem['scrollTop'] || docBody['scrollTop'],
                scrollBottom = (docElem['scrollHeight'] || docBody['scrollHeight']) - window.innerHeight
            return scrollTop / scrollBottom
        }
        let updateProgress = () => {
            currentScroll = getScrollAmount()
            $.post("{{ url_for('update_progress', id=text.id) }}", 
            {progress: currentScroll * 1_000_000})
            console.log("Progress set to " + currentScroll * 1_000_000)
        }
        debounced_updateProgress = _.debounce(updateProgress, 200)
        
        
        document.addEventListener("scroll", () => {
            document.getElementById("progress-bar").style.setProperty("--scrollAmount", getScrollAmount() * 100 + "%");
            $("#progress-indicator").text((getScrollAmount() * 100).toFixed(2) + "%")
            debounced_updateProgress()
        });

        window.addEventListener("resize", () => {
            scrollToFraction(currentScroll);
            console.log(currentScroll)
        })
            
        </script>
    <script>
        $('p').each(function () {
            $(this).html($(this).text()
                .split(/(?<=[\.\?!…] )/)
                .map(v => { return ' <span class="sentence">' + v.trimRight() + '</span> ' }));
        });

        $('span.sentence').click(obj => {
            let selection = window.getSelection();
            selection.modify('extend', 'backward', 'word');
            let a = selection.toString();

            selection.modify('extend', 'forward', 'word');
            while (selection.toString().slice(-1) == "-") {
                selection.modify('extend', 'forward', 'word');
            }
            let b = selection.toString();

            selection.modify('move', 'forward', 'character');
            word = (a + b).replace(/[.,\/#!$%\^&\*;:{}=\_…`~()]/g, "");
            console.log(word);
            console.log(obj)
            copyobj = {
                "sentence": obj.target.textContent.trim(),
                "word": word.trim()
            };
            console.log(copyobj)
            copyTextToClipboard(JSON.stringify(copyobj));
        });

        $("span.sentence").hover(function () {
            $(this).css("text-decoration", "underline #6b7 solid 3px");
            $(this).css("text-decoration-skip-ink", "none");
        },
            function () {
                $(this).css("text-decoration", "");
            });
    </script>
</body>

</html>